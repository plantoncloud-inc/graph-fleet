<!-- 7d993991-0dcd-4ff1-bbe7-d7941a5e08d7 7913d6b4-2869-4484-a5fd-6c8de1a8d7d2 -->
# Fix RemoveMessage Streaming Error in Deep Agents UI

## Problem Analysis

The UI error occurs because `RemoveMessage` instances (type: "remove") are being streamed to the JavaScript client, which only supports: human, AI, system, developer, and tool message types.

### Root Cause Investigation

**Inconsistency in deepagents library:**

1. **Code at `/Users/suresh/scm/github.com/langchain-ai/deepagents/src/deepagents/middleware/patch_tool_calls.py`** (lines 45-46):

   - Claims to return `None` when no patches needed
   - This should prevent RemoveMessage creation

2. **Test at `/Users/suresh/scm/github.com/langchain-ai/deepagents/tests/test_middleware.py`** (lines 223-237):

   - `test_first_message()` expects RemoveMessage even with NO tool calls
   - Contradicts the fix in the source code
   - This indicates the PR may not be fully merged or tests weren't updated

3. **Middleware Ordering Issue:**

   - In `graph.py` line 127: `PatchToolCallsMiddleware()` is added to standard middleware
   - In `graph.py` line 132: Custom middleware (including `FilterRemoveMessagesMiddleware`) is added AFTER
   - **However**: `FilterRemoveMessagesMiddleware` should still catch RemoveMessages if it's working correctly

### The Real Issue

The `FilterRemoveMessagesMiddleware.before_agent()` method only runs when the agent is about to execute. If `RemoveMessage` is being added to the state by `PatchToolCallsMiddleware.before_agent()` in the same middleware chain pass, the filtering happens BEFORE the problematic middleware creates the RemoveMessage.

**Middleware execution flow:**

```
User submits message
  ↓
FilterRemoveMessagesMiddleware.before_agent() runs - finds NO RemoveMessages yet ✓
  ↓  
PatchToolCallsMiddleware.before_agent() runs - CREATES RemoveMessage ✗
  ↓
State update with RemoveMessage gets streamed to UI ✗
```

## Solution

We need to add `after_agent` method to `FilterRemoveMessagesMiddleware` OR move it to run AFTER `PatchToolCallsMiddleware` in the middleware chain.

### Option 1: Add after_agent Hook (Preferred)

Modify `FilterRemoveMessagesMiddleware` in `/Users/suresh/scm/github.com/plantoncloud-inc/graph-fleet/src/agents/rds_manifest_generator/graph.py` to filter messages in `after_agent()` as well, which runs AFTER all other middleware.

### Option 2: Wait for DeepAgents PR Merge

The deepagents PR should fix the root cause. However, for immediate resolution, we need the defensive middleware to work correctly.

## Implementation Plan

1. **Update FilterRemoveMessagesMiddleware** to also implement `after_agent()` method
2. **Add logging** to track when RemoveMessages appear
3. **Test the fix** by submitting messages in the UI

## Files to Modify

- `/Users/suresh/scm/github.com/plantoncloud-inc/graph-fleet/src/agents/rds_manifest_generator/graph.py`
  - Add `after_agent()` method to `FilterRemoveMessagesMiddleware`
  - This catches RemoveMessages created by ANY middleware at ANY point