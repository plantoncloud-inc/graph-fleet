# Fix Graph Fleet Bazel Run Environment File Detection

**Date**: October 30, 2025

## Summary

Fixed the `graph_fleet_dev` Bazel run target to correctly locate `.env_export` file in the source directory instead of the Bazel output directory. The issue prevented launching LangGraph Studio via `bazel run` even when environment files were properly generated, causing a confusing error message about missing `.env_export`.

## Problem Statement

When running `bazel run //backend/services/graph-fleet:graph_fleet_dev`, the launch script failed with an error stating that `.env_export` was not found, even though the file existed in the source directory and had been successfully generated by `dot_env_local`.

### Pain Points

- **Confusing error message**: Instructed users to run `dot_env_local`, but running it again didn't fix the issue
- **Broken Bazel launch**: Could not launch graph-fleet via Bazel run targets, only by manually running `poetry run langgraph dev`
- **IDE integration broken**: IntelliJ run configurations for graph-fleet launch were non-functional
- **Developer confusion**: The error message suggested the `.env_export` file was missing, but it existed in the repo

### Root Cause

The `run_langgraph.sh` script used `$(dirname "${BASH_SOURCE[0]}")` to determine the service directory, which resolved to:
```
/private/var/tmp/_bazel_suresh/.../bazel-out/darwin_arm64-fastbuild/bin/backend/services/graph-fleet
```

This is the **Bazel output directory** where the script was executed from, not the **source directory** where `.env_export` actually exists:
```
/Users/suresh/scm/github.com/plantoncloud-inc/planton-cloud/backend/services/graph-fleet
```

## Solution

Updated `run_langgraph.sh` to use the `BUILD_WORKSPACE_DIRECTORY` environment variable (set by Bazel during `bazel run`) to locate the workspace root, then construct the path to the source directory from there.

### Implementation

**Before**:
```bash
SERVICE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
```
This resolved to the Bazel execution directory.

**After**:
```bash
# When run via 'bazel run', BUILD_WORKSPACE_DIRECTORY points to workspace root
# Otherwise fall back to git root for direct execution
REPO_ROOT="${BUILD_WORKSPACE_DIRECTORY:-$(git rev-parse --show-toplevel)}"
SERVICE_DIR="${REPO_ROOT}/backend/services/graph-fleet"
```

This ensures the script always finds the source directory regardless of where Bazel executes it from.

## Benefits

### Developer Experience
- **Working Bazel targets**: `bazel run //backend/services/graph-fleet:graph_fleet_dev` now works as expected
- **IDE integration restored**: IntelliJ run configurations for graph-fleet launch are functional
- **Clear workflow**: The standard two-step process (generate `.env` → launch service) now works correctly

### Consistency
- **Follows monorepo patterns**: Aligns with how other service launch scripts locate the workspace root
- **Compatible with direct execution**: The script works both via `bazel run` and when executed directly from the source directory

### Reliability
- **No path ambiguity**: Script always finds `.env_export` in the correct location
- **Error messages make sense**: If `.env_export` is truly missing, the error points to the actual source directory

## Technical Details

### How Bazel Executes sh_binary Targets

When running `bazel run //backend/services/graph-fleet:graph_fleet_dev`:

1. Bazel copies `run_langgraph.sh` to its output tree: `bazel-out/.../backend/services/graph-fleet/`
2. Bazel sets `BUILD_WORKSPACE_DIRECTORY` to the workspace root
3. Bazel executes the script from the output directory
4. The script uses `BUILD_WORKSPACE_DIRECTORY` to navigate to the source directory

### Why glob([".env_export"]) Didn't Help

The `BUILD.bazel` file included:
```python
data = glob([".env_export"], allow_empty = True) + [...]
```

However, `.env_export` is in `.gitignore`, and Bazel only tracks files visible to Git. The glob returns empty, and the file is never copied to the Bazel output directory. The solution is to navigate to the source directory instead of trying to copy the file.

### Fallback for Direct Execution

The script includes a fallback for direct execution (not via Bazel):
```bash
REPO_ROOT="${BUILD_WORKSPACE_DIRECTORY:-$(git rev-parse --show-toplevel)}"
```

If `BUILD_WORKSPACE_DIRECTORY` is not set, it uses `git rev-parse --show-toplevel` to find the repo root. This allows developers to run the script directly if needed.

## Usage

### Standard Workflow

1. **Generate environment file** (one time or when config changes):
   ```bash
   bazel run //backend/services/graph-fleet:dot_env_local
   ```

2. **Launch LangGraph Studio**:
   ```bash
   bazel run //backend/services/graph-fleet:graph_fleet_dev
   ```

3. **LangGraph Studio** starts with all environment variables loaded from `.env_export`

### IDE Integration

In IntelliJ/GoLand:
- Run `graph-fleet.dot-env.local` configuration to generate `.env`
- Run `graph-fleet.launch` configuration to start LangGraph Studio

## Impact

### Files Modified
- `backend/services/graph-fleet/run_langgraph.sh` - Updated SERVICE_DIR detection logic (2 lines changed)

### Developer Impact
- Restores functionality for all developers using Bazel run targets to launch graph-fleet
- Eliminates confusion from misleading error messages
- Enables seamless IDE-integrated development workflow

## Related Work

This fix completes the graph-fleet Bazel integration work documented in:
- `2025-10-30-graph-fleet-kustomize-integration.md` - Initial setup of Kustomize config and Bazel targets

The pattern of using `BUILD_WORKSPACE_DIRECTORY` to locate the workspace root is consistent with:
- `tools/local-dev/dot_env.sh` - Uses the same approach for environment file generation
- Other service launch scripts in the monorepo

---

**Status**: ✅ Production Ready  
**Impact**: Critical fix for local development workflow  
**Testing**: Verified `bazel run //backend/services/graph-fleet:graph_fleet_dev` successfully launches LangGraph Studio

