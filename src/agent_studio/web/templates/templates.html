{% extends "base.html" %}

{% block title %}Templates - Agent Studio{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h2 mb-3">
                <i class="fas fa-layer-group me-2"></i>
                Agent Templates
            </h1>
            <p class="text-muted">Browse and discover pre-built agent templates for different cloud providers and use cases.</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="/create" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>
                Create Custom Agent
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="filter-cloud" class="form-label">Cloud Provider</label>
                            <select class="form-select" id="filter-cloud">
                                <option value="">All Providers</option>
                                <option value="aws">AWS</option>
                                <option value="gcp">GCP</option>
                                <option value="azure">Azure</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filter-category" class="form-label">Category</label>
                            <select class="form-select" id="filter-category">
                                <option value="">All Categories</option>
                                <option value="cost_optimization">Cost Optimization</option>
                                <option value="security">Security</option>
                                <option value="troubleshooting">Troubleshooting</option>
                                <option value="architecture">Architecture</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filter-popularity" class="form-label">Sort By</label>
                            <select class="form-select" id="filter-popularity">
                                <option value="name">Name</option>
                                <option value="popularity">Popularity</option>
                                <option value="recent">Recently Updated</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="search-templates" class="form-label">Search</label>
                            <input type="text" class="form-control" id="search-templates" placeholder="Search templates...">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Featured Templates -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-star me-2"></i>
                        Featured Templates
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="featured-templates">
                        <!-- Featured templates will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates Grid -->
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">All Templates</h5>
                    <span class="badge bg-secondary" id="templates-count">0 templates</span>
                </div>
                <div class="card-body">
                    <!-- Loading State -->
                    <div id="templates-loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading templates...</p>
                    </div>

                    <!-- Empty State -->
                    <div id="templates-empty" class="text-center py-5 d-none">
                        <i class="fas fa-layer-group fa-4x text-muted mb-4"></i>
                        <h4>No templates found</h4>
                        <p class="text-muted mb-4">No templates match your current filters.</p>
                        <button class="btn btn-outline-primary" onclick="clearFilters()">
                            <i class="fas fa-filter me-2"></i>
                            Clear Filters
                        </button>
                    </div>

                    <!-- Templates Grid -->
                    <div id="templates-grid" class="row d-none">
                        <!-- Template cards will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template Details Modal -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="templateModalTitle">Template Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <h6>Description</h6>
                            <p id="template-description" class="text-muted"></p>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Capabilities</h6>
                            <div id="template-capabilities"></div>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Specializations</h6>
                            <div id="template-specializations"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Template Info</h6>
                                <ul class="list-unstyled mb-0">
                                    <li><strong>Cloud:</strong> <span id="template-cloud"></span></li>
                                    <li><strong>Version:</strong> <span id="template-version"></span></li>
                                    <li><strong>Author:</strong> <span id="template-author"></span></li>
                                    <li><strong>Usage:</strong> <span id="template-usage"></span></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h6>Tags</h6>
                            <div id="template-tags"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="useTemplate()">
                    <i class="fas fa-plus me-2"></i>
                    Use This Template
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentTemplates = [];
let selectedTemplateId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadTemplates();
    loadFeaturedTemplates();
    
    // Set up event listeners
    document.getElementById('filter-cloud').addEventListener('change', filterTemplates);
    document.getElementById('filter-category').addEventListener('change', filterTemplates);
    document.getElementById('filter-popularity').addEventListener('change', filterTemplates);
    document.getElementById('search-templates').addEventListener('input', filterTemplates);
});

async function loadTemplates() {
    try {
        const response = await AgentStudioAPI.get('/templates');
        currentTemplates = response.data;
        displayTemplates(currentTemplates);
    } catch (error) {
        console.error('Failed to load templates:', error);
        showError('Failed to load templates. Please try again.');
        showEmptyState();
    }
}

async function loadFeaturedTemplates() {
    try {
        const response = await AgentStudioAPI.get('/templates?featured=true&limit=3');
        const featured = response.data;
        
        const container = document.getElementById('featured-templates');
        container.innerHTML = featured.map(template => `
            <div class="col-md-4 mb-3">
                <div class="card border-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">${template.display_name}</h6>
                            <span class="badge bg-${getCloudColor(template.cloud_provider)}">${template.cloud_provider.toUpperCase()}</span>
                        </div>
                        <p class="card-text text-muted small">${template.description}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-users me-1"></i>
                                ${template.usage_count || 0} uses
                            </small>
                            <button class="btn btn-sm btn-outline-primary" onclick="showTemplateDetails('${template.id}')">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Failed to load featured templates:', error);
    }
}

function displayTemplates(templates) {
    const loadingEl = document.getElementById('templates-loading');
    const emptyEl = document.getElementById('templates-empty');
    const gridEl = document.getElementById('templates-grid');
    const countEl = document.getElementById('templates-count');
    
    loadingEl.classList.add('d-none');
    
    if (templates.length === 0) {
        emptyEl.classList.remove('d-none');
        gridEl.classList.add('d-none');
        countEl.textContent = '0 templates';
    } else {
        emptyEl.classList.add('d-none');
        gridEl.classList.remove('d-none');
        countEl.textContent = `${templates.length} template${templates.length !== 1 ? 's' : ''}`;
        
        gridEl.innerHTML = templates.map(template => `
            <div class="col-md-4 col-lg-3 mb-4">
                <div class="card h-100 template-card" onclick="showTemplateDetails('${template.id}')">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="card-title mb-0">${template.display_name}</h6>
                            <span class="badge bg-${getCloudColor(template.cloud_provider)}">${template.cloud_provider.toUpperCase()}</span>
                        </div>
                        
                        <p class="card-text text-muted small mb-3">${template.description}</p>
                        
                        <div class="mb-3">
                            ${template.specializations ? template.specializations.slice(0, 2).map(spec => 
                                `<span class="badge bg-light text-dark me-1">${formatSpecialization(spec)}</span>`
                            ).join('') : ''}
                            ${template.specializations && template.specializations.length > 2 ? 
                                `<span class="badge bg-light text-dark">+${template.specializations.length - 2}</span>` : ''}
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-users me-1"></i>
                                ${template.usage_count || 0}
                            </small>
                            <small class="text-muted">
                                <i class="fas fa-star me-1"></i>
                                ${template.rating || 'N/A'}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }
}

function filterTemplates() {
    const cloudFilter = document.getElementById('filter-cloud').value;
    const categoryFilter = document.getElementById('filter-category').value;
    const searchFilter = document.getElementById('search-templates').value.toLowerCase();
    const sortBy = document.getElementById('filter-popularity').value;
    
    let filteredTemplates = currentTemplates.filter(template => {
        const matchesCloud = !cloudFilter || template.cloud_provider === cloudFilter;
        const matchesCategory = !categoryFilter || (template.specializations && template.specializations.includes(categoryFilter));
        const matchesSearch = !searchFilter || 
            template.display_name.toLowerCase().includes(searchFilter) ||
            template.description.toLowerCase().includes(searchFilter);
        
        return matchesCloud && matchesCategory && matchesSearch;
    });
    
    // Sort templates
    filteredTemplates.sort((a, b) => {
        switch (sortBy) {
            case 'popularity':
                return (b.usage_count || 0) - (a.usage_count || 0);
            case 'recent':
                return new Date(b.updated_at || 0) - new Date(a.updated_at || 0);
            case 'name':
            default:
                return a.display_name.localeCompare(b.display_name);
        }
    });
    
    displayTemplates(filteredTemplates);
}

async function showTemplateDetails(templateId) {
    try {
        const response = await AgentStudioAPI.get(`/templates/${templateId}`);
        const template = response.data;
        
        selectedTemplateId = templateId;
        
        // Populate modal
        document.getElementById('templateModalTitle').textContent = template.display_name;
        document.getElementById('template-description').textContent = template.description;
        document.getElementById('template-cloud').textContent = template.cloud_provider.toUpperCase();
        document.getElementById('template-version').textContent = template.version;
        document.getElementById('template-author').textContent = template.author || 'Agent Studio';
        document.getElementById('template-usage').textContent = `${template.usage_count || 0} uses`;
        
        // Capabilities
        const capabilitiesEl = document.getElementById('template-capabilities');
        if (template.capabilities && template.capabilities.length > 0) {
            capabilitiesEl.innerHTML = template.capabilities.map(cap => 
                `<span class="badge bg-primary me-1 mb-1">${cap.name}</span>`
            ).join('');
        } else {
            capabilitiesEl.innerHTML = '<span class="text-muted">No specific capabilities listed</span>';
        }
        
        // Specializations
        const specializationsEl = document.getElementById('template-specializations');
        if (template.specializations && template.specializations.length > 0) {
            specializationsEl.innerHTML = template.specializations.map(spec => 
                `<span class="badge bg-info me-1 mb-1">${formatSpecialization(spec)}</span>`
            ).join('');
        } else {
            specializationsEl.innerHTML = '<span class="text-muted">General purpose template</span>';
        }
        
        // Tags
        const tagsEl = document.getElementById('template-tags');
        if (template.tags && template.tags.length > 0) {
            tagsEl.innerHTML = template.tags.map(tag => 
                `<span class="badge bg-secondary me-1 mb-1">${tag}</span>`
            ).join('');
        } else {
            tagsEl.innerHTML = '<span class="text-muted">No tags</span>';
        }
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('templateModal'));
        modal.show();
        
    } catch (error) {
        console.error('Failed to load template details:', error);
        showError('Failed to load template details');
    }
}

function useTemplate() {
    if (selectedTemplateId) {
        window.location.href = `/create?template=${selectedTemplateId}`;
    }
}

function clearFilters() {
    document.getElementById('filter-cloud').value = '';
    document.getElementById('filter-category').value = '';
    document.getElementById('filter-popularity').value = 'name';
    document.getElementById('search-templates').value = '';
    filterTemplates();
}

function showEmptyState() {
    document.getElementById('templates-loading').classList.add('d-none');
    document.getElementById('templates-empty').classList.remove('d-none');
    document.getElementById('templates-grid').classList.add('d-none');
}

function getCloudColor(cloudProvider) {
    switch (cloudProvider) {
        case 'aws': return 'warning';
        case 'gcp': return 'primary';
        case 'azure': return 'info';
        default: return 'secondary';
    }
}

function formatSpecialization(specialization) {
    return specialization.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}
</script>

<style>
.template-card {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.template-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>
{% endblock %}
