{% extends "base.html" %}

{% block title %}My Agents - Agent Studio{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h2 mb-3">
                <i class="fas fa-robot me-2"></i>
                My Agents
            </h1>
            <p class="text-muted">Manage your cloud agents and their configurations.</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="/create" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>
                Create New Agent
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="filter-cloud" class="form-label">Cloud Provider</label>
                            <select class="form-select" id="filter-cloud">
                                <option value="">All Providers</option>
                                <option value="aws">AWS</option>
                                <option value="gcp">GCP</option>
                                <option value="azure">Azure</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filter-specialization" class="form-label">Specialization</label>
                            <select class="form-select" id="filter-specialization">
                                <option value="">All Specializations</option>
                                <option value="cost_optimizer">Cost Optimizer</option>
                                <option value="security_auditor">Security Auditor</option>
                                <option value="troubleshooter">Troubleshooter</option>
                                <option value="architect">Architect</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filter-status" class="form-label">Status</label>
                            <select class="form-select" id="filter-status">
                                <option value="">All Statuses</option>
                                <option value="active">Active</option>
                                <option value="deployed">Deployed</option>
                                <option value="draft">Draft</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="search-agents" class="form-label">Search</label>
                            <input type="text" class="form-control" id="search-agents" placeholder="Search agents...">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agents List -->
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Agents</h5>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="view-mode" id="view-grid" checked>
                        <label class="btn btn-outline-secondary btn-sm" for="view-grid">
                            <i class="fas fa-th"></i>
                        </label>
                        <input type="radio" class="btn-check" name="view-mode" id="view-list">
                        <label class="btn btn-outline-secondary btn-sm" for="view-list">
                            <i class="fas fa-list"></i>
                        </label>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Loading State -->
                    <div id="agents-loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading your agents...</p>
                    </div>

                    <!-- Empty State -->
                    <div id="agents-empty" class="text-center py-5 d-none">
                        <i class="fas fa-robot fa-4x text-muted mb-4"></i>
                        <h4>No agents found</h4>
                        <p class="text-muted mb-4">You haven't created any agents yet, or no agents match your current filters.</p>
                        <a href="/create" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>
                            Create Your First Agent
                        </a>
                    </div>

                    <!-- Grid View -->
                    <div id="agents-grid" class="row d-none">
                        <!-- Agent cards will be populated here -->
                    </div>

                    <!-- List View -->
                    <div id="agents-list" class="d-none">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Cloud Provider</th>
                                        <th>Specialization</th>
                                        <th>Status</th>
                                        <th>Last Used</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="agents-table-body">
                                    <!-- Agent rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Agent Actions Modal -->
<div class="modal fade" id="agentActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agent Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" onclick="configureAgent()">
                        <i class="fas fa-cog me-2"></i>
                        Configure Agent
                    </button>
                    <button type="button" class="btn btn-success" onclick="deployAgent()">
                        <i class="fas fa-cloud me-2"></i>
                        Deploy Agent
                    </button>
                    <button type="button" class="btn btn-info" onclick="viewAgent()">
                        <i class="fas fa-eye me-2"></i>
                        View Details
                    </button>
                    <hr>
                    <button type="button" class="btn btn-warning" onclick="archiveAgent()">
                        <i class="fas fa-archive me-2"></i>
                        Archive Agent
                    </button>
                    <button type="button" class="btn btn-danger" onclick="deleteAgent()">
                        <i class="fas fa-trash me-2"></i>
                        Delete Agent
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentAgents = [];
let selectedAgentId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadAgents();
    
    // Set up event listeners
    document.getElementById('filter-cloud').addEventListener('change', filterAgents);
    document.getElementById('filter-specialization').addEventListener('change', filterAgents);
    document.getElementById('filter-status').addEventListener('change', filterAgents);
    document.getElementById('search-agents').addEventListener('input', filterAgents);
    
    // View mode toggles
    document.getElementById('view-grid').addEventListener('change', function() {
        if (this.checked) showGridView();
    });
    document.getElementById('view-list').addEventListener('change', function() {
        if (this.checked) showListView();
    });
});

async function loadAgents() {
    try {
        const response = await AgentStudioAPI.get('/agents/list');
        currentAgents = response.data;
        displayAgents(currentAgents);
    } catch (error) {
        console.error('Failed to load agents:', error);
        showError('Failed to load agents. Please try again.');
        showEmptyState();
    }
}

function displayAgents(agents) {
    const loadingEl = document.getElementById('agents-loading');
    const emptyEl = document.getElementById('agents-empty');
    const gridEl = document.getElementById('agents-grid');
    const listEl = document.getElementById('agents-list');
    
    loadingEl.classList.add('d-none');
    
    if (agents.length === 0) {
        emptyEl.classList.remove('d-none');
        gridEl.classList.add('d-none');
        listEl.classList.add('d-none');
    } else {
        emptyEl.classList.add('d-none');
        
        // Show appropriate view
        if (document.getElementById('view-grid').checked) {
            showGridView(agents);
        } else {
            showListView(agents);
        }
    }
}

function showGridView(agents = currentAgents) {
    const gridEl = document.getElementById('agents-grid');
    const listEl = document.getElementById('agents-list');
    
    listEl.classList.add('d-none');
    gridEl.classList.remove('d-none');
    
    gridEl.innerHTML = agents.map(agent => `
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5 class="card-title mb-0">${agent.name}</h5>
                        <span class="badge bg-${getStatusColor(agent.status)}">${agent.status}</span>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">
                            <i class="fas fa-cloud me-1"></i>
                            ${agent.cloud_provider.toUpperCase()}
                        </small>
                        ${agent.specialization ? `
                            <small class="text-muted d-block">
                                <i class="fas fa-cog me-1"></i>
                                ${formatSpecialization(agent.specialization)}
                            </small>
                        ` : ''}
                        ${agent.last_used ? `
                            <small class="text-muted d-block">
                                <i class="fas fa-clock me-1"></i>
                                ${formatDate(agent.last_used)}
                            </small>
                        ` : ''}
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-primary flex-fill" onclick="openAgentActions('${agent.id}')">
                            <i class="fas fa-cog me-1"></i>
                            Manage
                        </button>
                        <a href="/agents/${agent.id}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function showListView(agents = currentAgents) {
    const gridEl = document.getElementById('agents-grid');
    const listEl = document.getElementById('agents-list');
    const tableBodyEl = document.getElementById('agents-table-body');
    
    gridEl.classList.add('d-none');
    listEl.classList.remove('d-none');
    
    tableBodyEl.innerHTML = agents.map(agent => `
        <tr>
            <td>
                <strong>${agent.name}</strong>
            </td>
            <td>
                <span class="badge bg-secondary">${agent.cloud_provider.toUpperCase()}</span>
            </td>
            <td>
                ${agent.specialization ? formatSpecialization(agent.specialization) : '-'}
            </td>
            <td>
                <span class="badge bg-${getStatusColor(agent.status)}">${agent.status}</span>
            </td>
            <td>
                ${agent.last_used ? formatDate(agent.last_used) : 'Never'}
            </td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-primary" onclick="openAgentActions('${agent.id}')">
                        <i class="fas fa-cog"></i>
                    </button>
                    <a href="/agents/${agent.id}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i>
                    </a>
                </div>
            </td>
        </tr>
    `).join('');
}

function filterAgents() {
    const cloudFilter = document.getElementById('filter-cloud').value;
    const specializationFilter = document.getElementById('filter-specialization').value;
    const statusFilter = document.getElementById('filter-status').value;
    const searchFilter = document.getElementById('search-agents').value.toLowerCase();
    
    const filteredAgents = currentAgents.filter(agent => {
        const matchesCloud = !cloudFilter || agent.cloud_provider === cloudFilter;
        const matchesSpecialization = !specializationFilter || agent.specialization === specializationFilter;
        const matchesStatus = !statusFilter || agent.status === statusFilter;
        const matchesSearch = !searchFilter || agent.name.toLowerCase().includes(searchFilter);
        
        return matchesCloud && matchesSpecialization && matchesStatus && matchesSearch;
    });
    
    displayAgents(filteredAgents);
}

function openAgentActions(agentId) {
    selectedAgentId = agentId;
    const modal = new bootstrap.Modal(document.getElementById('agentActionsModal'));
    modal.show();
}

function configureAgent() {
    if (selectedAgentId) {
        window.location.href = `/agents/${selectedAgentId}/configure`;
    }
}

function deployAgent() {
    if (selectedAgentId) {
        window.location.href = `/agents/${selectedAgentId}/deploy`;
    }
}

function viewAgent() {
    if (selectedAgentId) {
        window.location.href = `/agents/${selectedAgentId}`;
    }
}

async function archiveAgent() {
    if (!selectedAgentId) return;
    
    if (confirm('Are you sure you want to archive this agent?')) {
        try {
            await AgentStudioAPI.put(`/agents/${selectedAgentId}/configure`, {
                status: 'archived'
            });
            showSuccess('Agent archived successfully');
            loadAgents();
            bootstrap.Modal.getInstance(document.getElementById('agentActionsModal')).hide();
        } catch (error) {
            console.error('Failed to archive agent:', error);
            showError('Failed to archive agent');
        }
    }
}

async function deleteAgent() {
    if (!selectedAgentId) return;
    
    if (confirm('Are you sure you want to delete this agent? This action cannot be undone.')) {
        try {
            await AgentStudioAPI.delete(`/agents/${selectedAgentId}`);
            showSuccess('Agent deleted successfully');
            loadAgents();
            bootstrap.Modal.getInstance(document.getElementById('agentActionsModal')).hide();
        } catch (error) {
            console.error('Failed to delete agent:', error);
            showError('Failed to delete agent');
        }
    }
}

function showEmptyState() {
    document.getElementById('agents-loading').classList.add('d-none');
    document.getElementById('agents-empty').classList.remove('d-none');
    document.getElementById('agents-grid').classList.add('d-none');
    document.getElementById('agents-list').classList.add('d-none');
}

function getStatusColor(status) {
    switch (status) {
        case 'active': return 'success';
        case 'deployed': return 'primary';
        case 'draft': return 'secondary';
        case 'archived': return 'warning';
        default: return 'secondary';
    }
}

function formatSpecialization(specialization) {
    return specialization.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString();
}
</script>
{% endblock %}
